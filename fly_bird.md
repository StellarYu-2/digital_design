🎯 FlappyBird游戏实施流程
阶段一：项目准备与素材制作 (1-2天)
1.1 图片素材准备
需要准备以下BMP格式图片（24位真彩色）：
| 素材名称            | 建议尺寸   | 说明                       |
| ------------------- | ---------- | -------------------------- |
| bird.bmp            | 40x40px    | 小鸟精灵图（可含多帧动画） |
| pipe_up.bmp         | 80x400px   | 向上的管道                 |
| pipe_down.bmp       | 80x400px   | 向下的管道                 |
| background.bmp      | 1024x768px | 游戏背景图                 |
| ground.bmp          | 1024x100px | 地面图                     |
| start_screen.bmp    | 1024x768px | 开始界面                   |
| gameover_screen.bmp | 1024x768px | 游戏结束界面               |
操作步骤：
- 使用图像编辑软件（如Paint、Photoshop）制作素材
- 确保所有图片都是24位BMP格式
- 将图片拷贝到SD卡根目录
- 使用WinHex工具查看每个BMP文件在SD卡中的扇区地址
1.2 FPGA工程配置检查
- 确认FPGA型号和引脚约束
- 检查时钟PLL配置（100MHz系统时钟，65MHz HDMI时钟）
- 确认SDRAM、SD卡、HDMI接口引脚定义
---
阶段二：游戏逻辑模块开发 (3-5天)
2.1 游戏参数定义模块 game_param.v
// 定义游戏常量
- 屏幕分辨率: 1024x768
- 小鸟初始位置: (200, 384)
- 重力加速度: 每帧+2像素
- 跳跃速度: -10像素/帧
- 管道宽度: 80像素
- 管道间隙: 200像素
- 管道移动速度: 2像素/帧
- 帧率控制: 60FPS
2.2 小鸟控制模块 bird_ctrl.v
功能：
- 小鸟Y坐标计算（重力 + 跳跃）
- 按键防抖处理
- 速度限制（最大下落/上升速度）
输入：
- clk, rst_n
- key_jump - 跳跃按键
- game_state - 游戏状态（0:待机，1:游戏中，2:结束）
输出：
- bird_x, bird_y - 小鸟当前坐标
- bird_velocity - 小鸟当前速度
2.3 管道生成模块 pipe_gen.v
功能：
- 生成3组管道（循环使用）
- 管道水平移动
- 伪随机数生成器（LFSR）控制管道高度
输入：
- clk, rst_n
- game_state
- frame_pulse - 帧同步信号
输出：
- pipe1_x, pipe1_gap_y - 管道1位置和间隙中心
- pipe2_x, pipe2_gap_y - 管道2位置和间隙中心
- pipe3_x, pipe3_gap_y - 管道3位置和间隙中心
2.4 碰撞检测模块 collision_check.v
功能：
- 检测小鸟与管道碰撞
- 检测小鸟与地面/天花板碰撞
输入：
- bird_x, bird_y - 小鸟坐标
- pipe_x[], pipe_gap_y[] - 所有管道信息
输出：
- collision - 碰撞标志
2.5 计分模块 score_counter.v
功能：
- 检测小鸟通过管道
- 累加分数
- 最高分记录
输入：
- clk, rst_n
- bird_x
- pipe_x[]
输出：
- score[15:0] - 当前分数
- high_score[15:0] - 最高分
2.6 游戏状态机 game_fsm.v
状态定义：
- IDLE - 等待开始
- PLAYING - 游戏进行中
- GAME_OVER - 游戏结束
- RESTART - 重新开始
输入：
- clk, rst_n
- key_start - 开始按键
- collision - 碰撞信号
输出：
- game_state[1:0]
---
阶段三：图像存储与读取改造 (2-3天)
3.1 多图片SD卡读取模块 sd_multi_pic.v
改造 sd_read_photo.v：
- 支持读取多个BMP文件（7个素材）
- 每个图片分配固定SDRAM地址空间
- 建立图片ID到扇区地址的映射表
SDRAM地址分配方案（1024x768, 每像素16位）：
0x000000 - 0x0BF3FF: 背景图 (786432字节)
0x0BF400 - 0x17E7FF: 开始界面 (786432字节)
0x17E800 - 0x23DBFF: 游戏结束界面 (786432字节)
0x23DC00 - 0x240FFF: 小鸟图 (1600字节)
0x241000 - 0x25C3FF: 管道上 (112000字节)
0x25C400 - 0x2777FF: 管道下 (112000字节)
0x277800 - 0x28FBFF: 地面图 (102400字节)
3.2 双缓冲SDRAM控制
- 修改 sdram_top.v，增加多区域读写控制
- 实现背景层 + 精灵层的分层读取
---
阶段四：HDMI显示集成 (2-3天)
4.1 精灵显示模块 sprite_render.v
功能：
- 根据当前扫描坐标判断显示内容
- 透明色处理（色键）
- 多图层叠加（背景→管道→小鸟→地面）
输入：
- pixel_x, pixel_y - 当前扫描位置
- bird_x, bird_y - 小鸟坐标
- pipe_x[], pipe_gap_y[] - 管道信息
- game_state - 游戏状态
- SDRAM读取数据接口
输出：
- pixel_rgb[15:0] - 当前像素颜色
- SDRAM读取地址
4.2 HDMI显示顶层改造 hdmi_game_top.v
集成：
- 修改 hdmi_top.v，替换简单图片显示为游戏渲染逻辑
- 添加帧同步信号生成（60Hz）
- 连接游戏逻辑模块与显示模块
---
阶段五：系统集成与顶层设计 (2天)
5.1 游戏顶层模块 flappy_bird_game.v
集成所有游戏模块：
module flappy_bird_game(
    input sys_clk,
    input sys_rst_n,
    input key_jump,      // 跳跃按键
    input key_start,     // 开始按键
    
    // SD卡接口
    input sd_miso,
    output sd_clk, sd_cs, sd_mosi,
    
    // SDRAM接口
    output sdram_clk, sdram_cke, ...
    inout [15:0] sdram_data,
    
    // HDMI接口
    output tmds_clk_p, tmds_clk_n,
    output [2:0] tmds_data_p, tmds_data_n,
    
    // 调试接口（可选）
    output [15:0] score_display
);
5.2 系统顶层 sd_bmp_hdmi.v 改造
- 替换原始图片显示逻辑为游戏逻辑
- 添加按键输入接口
- 保留时钟生成、SDRAM控制等基础设施
---
阶段六：仿真验证 (1-2天)
6.1 模块级仿真
- 小鸟运动仿真（重力、跳跃）
- 管道生成与移动仿真
- 碰撞检测仿真
6.2 系统级仿真
- SD卡读取流程验证
- SDRAM读写时序验证
- 显示坐标计算验证
---
阶段七：板级调试与优化 (2-3天)
7.1 硬件测试
1. SD卡图片读取测试
2. HDMI显示测试（静态背景）
3. 按键输入测试
4. 小鸟运动测试
5. 管道生成测试
6. 碰撞检测测试
7. 完整游戏流程测试
7.2 性能优化
- 调整帧率（确保60FPS稳定）
- 优化SDRAM带宽使用
- 调整游戏难度参数
7.3 功能扩展（可选）
- 添加声音效果（蜂鸣器）
- 七段数码管显示分数
- 暂停功能
- 多关卡设计
---
📁 最终文件结构
rtl/
├── game/                          # 新增游戏模块目录
│   ├── game_param.v              # 游戏参数定义
│   ├── bird_ctrl.v               # 小鸟控制
│   ├── pipe_gen.v                # 管道生成
│   ├── collision_check.v         # 碰撞检测
│   ├── score_counter.v           # 计分模块
│   ├── game_fsm.v                # 游戏状态机
│   ├── sprite_render.v           # 精灵渲染
│   └── flappy_bird_game.v        # 游戏顶层
├── sd_ctrl_top/                  # SD卡控制（保留）
├── sdram/                        # SDRAM控制（保留）
├── hdmi/                         # HDMI显示（保留）
├── sd_multi_pic.v                # 改造：多图片读取
└── sd_bmp_hdmi.v                 # 改造：系统顶层
---
⚠️ 关键技术要点
1. 时序同步
- 游戏逻辑：50MHz时钟域
- SDRAM控制：100MHz时钟域
- HDMI显示：65MHz时钟域
- 需要跨时钟域处理（使用FIFO或CDC）
2. SDRAM带宽计算
- 1024x768@60Hz = 47.19MHz像素时钟
- 每像素16位 = 94.38MB/s读带宽
- 背景+精灵需要多次读取，注意带宽瓶颈
3. 透明色处理
- 选择特定颜色作为透明色（如品红色 0xF81F）
- 在精灵渲染时跳过透明像素
4. 碰撞检测优化
- 使用矩形包围盒检测（而非像素级）
- 管道碰撞：检查鸟的边界与管道边界
- 地面碰撞：bird_y > 668 (768-100)
---
🎮 按键定义建议
- KEY1: 跳跃（游戏中）/ 开始（待机状态）
- KEY2: 重新开始（游戏结束状态）
- KEY3: 暂停/继续（可选）
---
📊 开发时间估算
| 阶段             | 预计时间 | 难度 |
| ---------------- | -------- | ---- |
| 阶段一：素材准备 | 1-2天    | ⭐    |
| 阶段二：游戏逻辑 | 3-5天    | ⭐⭐⭐  |
| 阶段三：图像存储 | 2-3天    | ⭐⭐⭐⭐ |
| 阶段四：显示集成 | 2-3天    | ⭐⭐⭐⭐ |
| 阶段五：系统集成 | 2天      | ⭐⭐   |
| 阶段六：仿真验证 | 1-2天    | ⭐⭐   |
| 阶段七：板级调试 | 2-3天    | ⭐⭐⭐  |
| 总计             | 13-20天  | -    |
---
❓ 下一步建议
我建议按以下顺序开始实施：
1. 先完成阶段一：准备好所有BMP素材并测试SD卡读取
2. 验证当前工程：确保现有的SD卡→SDRAM→HDMI链路工作正常
3. 逐步开发游戏模块：从最简单的小鸟运动开始
4. 分层测试：每完成一个模块就上板验证
你现在想要：
- A. 立即开始实施（我将引导你完成每个阶段）
- B. 先讨论某个具体技术难点（如碰撞检测算法、SDRAM地址分配等）
- C. 修改计划（调整某些设计方案）